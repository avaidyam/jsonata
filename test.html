<!DOCTYPE html>
<html>
<body>
<script type="text/javascript" src="./jsonata.js"></script>
<script>

const delay = async (ms, value) =>
  new Promise((resolve) => setTimeout(resolve, ms, value));

async function run(expr) {
  const start = new Date().getTime()
  console.log("started")
  var expression = jsonata(expr);
  expression.registerFunction(
    "Study_all",
    async (a) =>
      await delay(700, [
        { id: 1, name: "StudyA" },
        { id: 2, name: "StudyB" }
      ])
  );
  expression.registerFunction(
    "Participant_all",
    async (a) => await delay(700, [{ id: 1 }, { id: 2 }])
  );
  expression.registerFunction(
    "Tags_view",
    async (a) => await delay(700, "TagName" + a)
  );
  expression.registerFunction(
    "ActivityEvent_all",
    async (a) =>
      await delay(700, [
        { timestamp: 1, data: "A_" + a },
        { timestamp: 2, data: "B_" + a }
      ])
  );
  expression.registerFunction(
    "SensorEvent_all",
    async (a) =>
      await delay(700, [
        { timestamp: 1, data: "C_" + a },
        { timestamp: 2, data: "D_" + a }
      ])
  );
  expression.registerFunction("resolveParallel", async (funcs) => {
    //return Promise.all(funcs.map((fn) => fulfill(fn.apply(fn))));
    return resolveParallel(funcs);
  });
  expression.registerFunction("mapParallel", async (items, func) => {
    return Promise.all(items.map((item) => fulfill(func(item))));
  });
  let result = await expression.evaluate({}, {})
  console.log("time: " + (new Date().getTime() - start))
  return result
}

async function resolveParallel(query) {
  if (query && query.apply) return fulfill(query.apply(query));
  if (Array.isArray(query)) return Promise.all(query.map(resolveParallel));
  if (typeof query === "object")
    return Object.fromEntries(
      await Promise.all(
        Object.entries(query).map(async ([k, val]) => [
          k,
          await resolveParallel(val)
        ])
      )
    );
  return query;
}

function fulfill(iterator) {
  function doNext(arg) {
    const next = iterator.next(arg);
    return next.done ? next.value : Promise.resolve(next.value).then(doNext);
  }
  //return doNext();
  return iterator;
}

const expr = `
$mapParallel($Study_all("dnbd16yj2zkegk67aqm8"), function($s){{
  "id": $s.id,
  "name": $s.name,
  "participants": $mapParallel($Participant_all($s.id), function($p){
    $resolveParallel({
      "id": $p.id, 
      "name": function(){$Tags_view($p.id, "lamp.name")},
      "last_activity": function(){$ActivityEvent_all($p.id, null, null, null, 1)},
      "last_sensor": function(){$SensorEvent_all($p.id, "lamp.analytics", null, null, 1)}
    })
  })
}})`

const expr2 = `
$Study_all("dnbd16yj2zkegk67aqm8").{
  "test": $contains("hello World", /wo/),
  "id": id,
  "name": name,
  "participants": $Participant_all(id).{
    "id": id, 
    "name": $Tags_view(id, "lamp.name"),
    "last_activity": $ActivityEvent_all(id, null, null, null, 1),
    "last_sensor": $SensorEvent_all(id, "lamp.analytics", null, null, 1)
  }
}`

run(expr).then(console.dir).catch(console.dir)
run(expr2).then(console.dir).catch(console.dir)
</script>
</body>
</html>